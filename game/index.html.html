<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Word Room ‚Äî English Match Game</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1a2e;
    --card-bg: #1a2d4a;
    --card-border: #2a4570;
    --accent1: #ff6b6b;
    --accent2: #ffd93d;
    --accent3: #6bceff;
    --accent4: #6bff9e;
    --text: #e8f4ff;
    --muted: #7a9cc0;
    --easy: #6bff9e;
    --medium: #ffd93d;
    --hard: #ff6b6b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Starfield background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 80% 10%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 50% 70%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 10% 60%, rgba(255,255,255,0.2) 0%, transparent 100%),
      radial-gradient(1px 1px at 90% 80%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 35% 90%, rgba(255,255,255,0.3) 0%, transparent 100%),
      radial-gradient(1px 1px at 65% 50%, rgba(255,255,255,0.2) 0%, transparent 100%),
      radial-gradient(2px 2px at 75% 25%, rgba(255,220,100,0.3) 0%, transparent 100%),
      radial-gradient(2px 2px at 15% 45%, rgba(100,200,255,0.3) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  /* ===== SCREENS ===== */
  .screen { display: none; min-height: 100vh; position: relative; z-index: 1; }
  .screen.active { display: flex; flex-direction: column; }

  /* ===== HOME SCREEN ===== */
  #home {
    align-items: center;
    justify-content: center;
    padding: 2rem;
    gap: 2rem;
  }

  .logo {
    text-align: center;
    animation: floatIn 0.8s ease-out;
  }

  .logo h1 {
    font-family: 'Fredoka One', cursive;
    font-size: clamp(2.5rem, 8vw, 5rem);
    background: linear-gradient(135deg, var(--accent3) 0%, var(--accent4) 50%, var(--accent2) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: none;
    line-height: 1;
    filter: drop-shadow(0 0 30px rgba(107, 206, 255, 0.4));
  }

  .logo p {
    color: var(--muted);
    font-size: 1rem;
    margin-top: 0.5rem;
    font-weight: 700;
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    width: 100%;
    max-width: 720px;
    animation: slideUp 0.6s 0.2s ease-out both;
  }

  .cat-btn {
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 20px;
    padding: 1.2rem 1rem;
    cursor: pointer;
    transition: all 0.25s ease;
    text-align: center;
    color: var(--text);
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 0.9rem;
    position: relative;
    overflow: hidden;
  }

  .cat-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.25s;
    border-radius: 18px;
  }

  .cat-btn:hover { transform: translateY(-4px) scale(1.03); border-color: var(--accent3); }
  .cat-btn:hover::before { opacity: 1; }
  .cat-btn.selected { border-color: var(--accent2); background: rgba(255,217,61,0.15); }

  .cat-emoji { font-size: 2rem; display: block; margin-bottom: 0.4rem; }
  .cat-count { font-size: 0.75rem; color: var(--muted); font-weight: 700; margin-top: 0.3rem; }

  .difficulty-row {
    display: flex;
    gap: 1rem;
    animation: slideUp 0.6s 0.4s ease-out both;
  }

  .diff-btn {
    flex: 1;
    padding: 0.9rem 1.5rem;
    border: 2px solid transparent;
    border-radius: 50px;
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.25s;
    letter-spacing: 1px;
  }

  .diff-btn.easy { background: rgba(107,255,158,0.15); border-color: var(--easy); color: var(--easy); }
  .diff-btn.medium { background: rgba(255,217,61,0.15); border-color: var(--medium); color: var(--medium); }
  .diff-btn.hard { background: rgba(255,107,107,0.15); border-color: var(--hard); color: var(--hard); }
  .diff-btn:hover, .diff-btn.selected { filter: brightness(1.3); transform: scale(1.05); }
  .diff-btn.easy.selected { background: rgba(107,255,158,0.35); }
  .diff-btn.medium.selected { background: rgba(255,217,61,0.35); }
  .diff-btn.hard.selected { background: rgba(255,107,107,0.35); }

  .start-btn {
    background: linear-gradient(135deg, var(--accent3), var(--accent4));
    border: none;
    border-radius: 50px;
    padding: 1rem 3rem;
    font-family: 'Fredoka One', cursive;
    font-size: 1.4rem;
    color: #0f1a2e;
    cursor: pointer;
    transition: all 0.25s;
    letter-spacing: 1px;
    animation: slideUp 0.6s 0.6s ease-out both;
    box-shadow: 0 8px 30px rgba(107,206,255,0.4);
  }

  .start-btn:hover { transform: scale(1.06); box-shadow: 0 12px 40px rgba(107,206,255,0.6); }
  .start-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* ===== GAME SCREEN ===== */
  #game { padding: 1rem; gap: 1rem; }

  .game-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .back-btn {
    background: none;
    border: 2px solid var(--card-border);
    color: var(--muted);
    border-radius: 50px;
    padding: 0.4rem 1rem;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
  }
  .back-btn:hover { border-color: var(--accent3); color: var(--accent3); }

  .game-meta {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .stat-pill {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 50px;
    padding: 0.4rem 1rem;
    font-size: 0.85rem;
    font-weight: 800;
  }

  .score-val { color: var(--accent2); }
  .set-val { color: var(--accent3); }

  .progress-bar {
    height: 6px;
    background: var(--card-border);
    border-radius: 10px;
    overflow: hidden;
    margin: 0 0.5rem;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent3), var(--accent4));
    border-radius: 10px;
    transition: width 0.4s ease;
  }

  /* Cards grid */
  .cards-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .section-label {
    font-family: 'Fredoka One', cursive;
    font-size: 0.85rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    padding: 0 0.5rem;
  }

  .cards-row {
    display: grid;
    gap: 0.6rem;
  }

  .card {
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 16px;
    padding: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    font-weight: 800;
    font-size: 0.95rem;
    position: relative;
    user-select: none;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 0.2rem;
  }

  .card:hover:not(.matched):not(.wrong) {
    transform: translateY(-2px);
    border-color: var(--accent3);
    box-shadow: 0 6px 20px rgba(107,206,255,0.25);
  }

  .card.selected {
    border-color: var(--accent2);
    background: rgba(255,217,61,0.18);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(255,217,61,0.3);
  }

  .card.matched {
    border-color: var(--easy);
    background: rgba(107,255,158,0.18);
    animation: matchPop 0.5s ease;
    cursor: default;
    opacity: 0.7;
  }

  .card.wrong {
    border-color: var(--hard);
    background: rgba(255,107,107,0.18);
    animation: shake 0.4s ease;
  }

  .card .emoji-icon { font-size: 1.4rem; line-height: 1; }
  .card .word-en { font-size: 0.9rem; color: var(--accent3); font-weight: 900; }
  .card .word-ja { font-size: 0.75rem; color: var(--muted); }

  .speak-btn {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.75rem;
    opacity: 0.6;
    padding: 2px 4px;
    border-radius: 4px;
    transition: opacity 0.2s;
    z-index: 2;
  }
  .speak-btn:hover { opacity: 1; }

  /* ===== RESULT SCREEN ===== */
  #result {
    align-items: center;
    justify-content: center;
    padding: 2rem;
    gap: 2rem;
    text-align: center;
  }

  .result-emoji {
    font-size: 5rem;
    animation: bounceIn 0.6s ease-out;
  }

  .result-title {
    font-family: 'Fredoka One', cursive;
    font-size: 2.5rem;
    background: linear-gradient(135deg, var(--accent2), var(--accent3));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: floatIn 0.5s 0.2s ease-out both;
  }

  .result-stats {
    display: flex;
    gap: 2rem;
    animation: floatIn 0.5s 0.4s ease-out both;
  }

  .result-stat {
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 20px;
    padding: 1.5rem 2rem;
    min-width: 120px;
  }

  .result-stat-val {
    font-family: 'Fredoka One', cursive;
    font-size: 2.5rem;
    color: var(--accent2);
    display: block;
  }

  .result-stat-label {
    font-size: 0.8rem;
    color: var(--muted);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .result-btns {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
    animation: slideUp 0.5s 0.6s ease-out both;
  }

  .result-btn {
    border: 2px solid;
    border-radius: 50px;
    padding: 0.8rem 2rem;
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.25s;
  }

  .result-btn.primary {
    background: linear-gradient(135deg, var(--accent3), var(--accent4));
    border-color: transparent;
    color: #0f1a2e;
  }

  .result-btn.secondary {
    background: transparent;
    border-color: var(--muted);
    color: var(--text);
  }

  .result-btn:hover { transform: scale(1.05); filter: brightness(1.2); }

  /* ===== TEST INPUT STATES ===== */
  #testInput:focus {
    border-color: var(--accent3);
    box-shadow: 0 0 0 3px rgba(107, 206, 255, 0.2);
  }

  #testInput.correct {
    border-color: var(--easy);
    background: rgba(107,255,158,0.15);
    animation: correctPulse 0.5s ease;
  }

  #testInput.incorrect {
    border-color: var(--hard);
    background: rgba(255,107,107,0.15);
    animation: shake 0.4s ease;
  }

  @keyframes correctPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }

  /* ===== LISTENING OPTIONS ===== */
  .listening-option {
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 16px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-weight: 800;
    font-size: 1.1rem;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 0.5rem;
  }

  .listening-option:hover {
    transform: translateY(-2px);
    border-color: var(--accent3);
    box-shadow: 0 6px 20px rgba(107,206,255,0.25);
  }

  .listening-option.correct {
    border-color: var(--easy);
    background: rgba(107,255,158,0.18);
    animation: matchPop 0.5s ease;
  }

  .listening-option.incorrect {
    border-color: var(--hard);
    background: rgba(255,107,107,0.18);
    animation: shake 0.4s ease;
  }

  .listening-option .option-icon {
    font-size: 2rem;
    line-height: 1;
  }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: var(--accent4);
    color: #0f1a2e;
    padding: 0.7rem 2rem;
    border-radius: 50px;
    font-weight: 900;
    font-size: 1rem;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 100;
    font-family: 'Nunito', sans-serif;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* ===== ANIMATIONS ===== */
  @keyframes floatIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes bounceIn {
    0% { transform: scale(0); }
    60% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }
  @keyframes matchPop {
    0% { transform: scale(1); }
    40% { transform: scale(1.12); }
    100% { transform: scale(1); }
  }
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-5px); }
    80% { transform: translateX(5px); }
  }
  @keyframes confettiFall {
    0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
    100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
  }

  .confetti-piece {
    position: fixed;
    width: 10px;
    height: 10px;
    border-radius: 2px;
    animation: confettiFall linear forwards;
    pointer-events: none;
    z-index: 200;
  }

  /* Responsive */
  @media (min-width: 600px) {
    .cards-row { grid-template-columns: repeat(2, 1fr); }
  }
  @media (min-width: 900px) {
    .cards-row { grid-template-columns: repeat(5, 1fr); }
  }
</style>
</head>
<body>

<!-- ===== HOME ===== -->
<div id="home" class="screen active">
  <div class="logo">
    <h1>Word Room</h1>
    <p>English Match Game</p>
  </div>

  <div class="category-grid" id="categoryGrid"></div>

  <div style="text-align:center; color:var(--muted); font-size:0.85rem; font-weight:700; animation: slideUp 0.6s 0.3s ease-out both;">
    „Ç≤„Éº„É†„É¢„Éº„Éâ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ
  </div>

  <div class="difficulty-row" style="max-width: 720px; margin: 0 auto;">
    <button class="diff-btn easy" onclick="selectMode('match')" style="flex: 1;">üé¥ „Éû„ÉÉ„ÉÅ„É≥„Ç∞</button>
    <button class="diff-btn medium" onclick="selectMode('listening')" style="flex: 1;">üéß „É™„Çπ„Éã„É≥„Ç∞</button>
    <button class="diff-btn hard" onclick="selectMode('test')" style="flex: 1;">‚úèÔ∏è „ÉÜ„Çπ„Éà</button>
  </div>

  <div style="text-align:center; color:var(--muted); font-size:0.85rem; font-weight:700; margin-top: 1rem; animation: slideUp 0.6s 0.4s ease-out both;">
    Èõ£ÊòìÂ∫¶„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ
  </div>

  <div class="difficulty-row">
    <button class="diff-btn easy" onclick="selectDiff('easy')">‚≠ê Easy</button>
    <button class="diff-btn medium" onclick="selectDiff('medium')">‚≠ê‚≠ê Medium</button>
    <button class="diff-btn hard" onclick="selectDiff('hard')">‚≠ê‚≠ê‚≠ê Hard</button>
  </div>

  <button class="start-btn" id="startBtn" onclick="startGame()" disabled>‚ñ∂ „Çπ„Çø„Éº„ÉàÔºÅ</button>
</div>

<!-- ===== GAME ===== -->
<div id="game" class="screen">
  <div class="game-header">
    <button class="back-btn" onclick="goHome()">‚Üê „Éõ„Éº„É†</button>
    <div class="game-meta">
      <div class="stat-pill">„Çπ„Ç≥„Ç¢: <span class="score-val" id="scoreDisplay">0</span></div>
      <div class="stat-pill">„Çª„ÉÉ„Éà: <span class="set-val" id="setDisplay">1/5</span></div>
      <div class="stat-pill" id="diffPill"></div>
    </div>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>

  <div class="cards-container" id="cardsContainer"></div>
</div>

<!-- ===== LISTENING MODE ===== -->
<div id="listening" class="screen">
  <div class="game-header">
    <button class="back-btn" onclick="goHome()">‚Üê „Éõ„Éº„É†</button>
    <div class="game-meta">
      <div class="stat-pill">„Çπ„Ç≥„Ç¢: <span class="score-val" id="listeningScore">0</span></div>
      <div class="stat-pill">ÂïèÈ°å: <span class="set-val" id="listeningQuestion">1/50</span></div>
    </div>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="listeningProgress" style="width:0%"></div>
  </div>

  <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2rem; padding: 2rem;">
    <div style="text-align: center;">
      <div style="font-size: 4rem; margin-bottom: 1rem;">üéß</div>
      <button id="listenBtn" onclick="playListeningWord()" style="
        background: linear-gradient(135deg, var(--accent3), var(--accent4));
        border: none;
        border-radius: 50px;
        padding: 1.5rem 3rem;
        font-family: 'Fredoka One', cursive;
        font-size: 1.8rem;
        color: #0f1a2e;
        cursor: pointer;
        box-shadow: 0 8px 30px rgba(107,206,255,0.4);
        transition: all 0.25s;
      ">üîä ËÅû„Åè</button>
    </div>

    <div id="listeningOptions" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; width: 100%; max-width: 600px;"></div>
  </div>
</div>

<!-- ===== TEST MODE ===== -->
<div id="test" class="screen">
  <div class="game-header">
    <button class="back-btn" onclick="goHome()">‚Üê „Éõ„Éº„É†</button>
    <div class="game-meta">
      <div class="stat-pill">„Çπ„Ç≥„Ç¢: <span class="score-val" id="testScore">0</span></div>
      <div class="stat-pill">ÂïèÈ°å: <span class="set-val" id="testQuestion">1/50</span></div>
    </div>
  </div>

  <div class="progress-bar">
    <div class="progress-fill" id="testProgress" style="width:0%"></div>
  </div>

  <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2rem; padding: 2rem;">
    <div style="text-align: center; width: 100%; max-width: 500px;">
      <div id="testPrompt" style="
        background: var(--card-bg);
        border: 2px solid var(--card-border);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
      ">
        <div style="font-size: 3rem; margin-bottom: 1rem;" id="testIcon">üçé</div>
        <div style="font-size: 2rem; font-weight: 900; color: var(--text);" id="testWord">„Çä„Çì„Åî</div>
      </div>

      <div style="position: relative;">
        <input type="text" id="testInput" placeholder="Ëã±Ë™û„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." style="
          width: 100%;
          background: var(--card-bg);
          border: 2px solid var(--card-border);
          border-radius: 50px;
          padding: 1.2rem 1.5rem;
          font-family: 'Nunito', sans-serif;
          font-size: 1.2rem;
          font-weight: 700;
          color: var(--text);
          text-align: center;
          outline: none;
          transition: all 0.2s;
        " onkeypress="if(event.key==='Enter') checkTestAnswer()">
      </div>

      <button onclick="checkTestAnswer()" style="
        background: linear-gradient(135deg, var(--accent3), var(--accent4));
        border: none;
        border-radius: 50px;
        padding: 1rem 3rem;
        font-family: 'Fredoka One', cursive;
        font-size: 1.4rem;
        color: #0f1a2e;
        cursor: pointer;
        margin-top: 1.5rem;
        box-shadow: 0 8px 30px rgba(107,206,255,0.4);
        transition: all 0.25s;
        width: 100%;
        max-width: 300px;
      ">‚úì Á≠î„ÅàÂêà„Çè„Åõ</button>
    </div>
  </div>
</div>

<!-- ===== RESULT ===== -->
<div id="result" class="screen">
  <div class="result-emoji" id="resultEmoji">üéâ</div>
  <div class="result-title" id="resultTitle">„Åô„Åî„ÅÑÔºÅ</div>

  <div class="result-stats">
    <div class="result-stat">
      <span class="result-stat-val" id="finalScore">0</span>
      <span class="result-stat-label">„Çπ„Ç≥„Ç¢</span>
    </div>
    <div class="result-stat">
      <span class="result-stat-val" id="finalAccuracy">0%</span>
      <span class="result-stat-label">Ê≠£Ëß£Áéá</span>
    </div>
    <div class="result-stat">
      <span class="result-stat-val" id="finalMatches">0</span>
      <span class="result-stat-label">„Éû„ÉÉ„ÉÅÊï∞</span>
    </div>
  </div>

  <div class="result-btns">
    <button class="result-btn primary" onclick="retryGame()">üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
    <button class="result-btn secondary" onclick="goHome()">üè† „Éõ„Éº„É†</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// =====================================================
// VOCABULARY DATA
// =====================================================
const CATEGORIES = {
  food: {
    label: 'È£ü„ÅπÁâ©', emoji: 'üçé',
    words: [
      { en: 'apple', ja: '„Çä„Çì„Åî', icon: 'üçé' },
      { en: 'banana', ja: '„Éê„Éä„Éä', icon: 'üçå' },
      { en: 'cherry', ja: '„Åï„Åè„Çâ„Çì„Åº', icon: 'üçí' },
      { en: 'grapes', ja: '„Å∂„Å©„ÅÜ', icon: 'üçá' },
      { en: 'lemon', ja: '„É¨„É¢„É≥', icon: 'üçã' },
      { en: 'melon', ja: '„É°„É≠„É≥', icon: 'üçà' },
      { en: 'orange', ja: '„Ç™„É¨„É≥„Ç∏', icon: 'üçä' },
      { en: 'peach', ja: '„ÇÇ„ÇÇ', icon: 'üçë' },
      { en: 'pineapple', ja: '„Éë„Ç§„Éä„ÉÉ„Éó„É´', icon: 'üçç' },
      { en: 'strawberry', ja: '„ÅÑ„Å°„Åî', icon: 'üçì' },
      { en: 'watermelon', ja: '„Åô„ÅÑ„Åã', icon: 'üçâ' },
      { en: 'kiwi fruit', ja: '„Ç≠„Ç¶„Ç§', icon: 'ü•ù' },
      { en: 'broccoli', ja: '„Éñ„É≠„ÉÉ„Ç≥„É™„Éº', icon: 'ü•¶' },
      { en: 'carrot', ja: '„Å´„Çì„Åò„Çì', icon: 'ü•ï' },
      { en: 'corn', ja: '„Å®„ÅÜ„ÇÇ„Çç„Åì„Åó', icon: 'üåΩ' },
      { en: 'tomato', ja: '„Éà„Éû„Éà', icon: 'üçÖ' },
      { en: 'onion', ja: '„Åü„Åæ„Å≠„Åé', icon: 'üßÖ' },
      { en: 'potato', ja: '„Åò„ÇÉ„Åå„ÅÑ„ÇÇ', icon: 'ü•î' },
      { en: 'mushroom', ja: '„Åç„ÅÆ„Åì', icon: 'üçÑ' },
      { en: 'cabbage', ja: '„Ç≠„É£„Éô„ÉÑ', icon: 'ü•¨' },
      { en: 'lettuce', ja: '„É¨„Çø„Çπ', icon: 'ü•ó' },
      { en: 'cucumber', ja: '„Åç„ÇÖ„ÅÜ„Çä', icon: 'ü•í' },
      { en: 'radish', ja: '„Å†„ÅÑ„Åì„Çì', icon: 'üå±' },
    ]
  },
  meals: {
    label: 'ÊñôÁêÜ„ÉªÈ£≤„ÅøÁâ©', emoji: 'üçî',
    words: [
      { en: 'bread', ja: '„Éë„É≥', icon: 'üçû' },
      { en: 'pizza', ja: '„Éî„Ç∂', icon: 'üçï' },
      { en: 'spaghetti', ja: '„Çπ„Éë„Ç≤„ÉÉ„ÉÜ„Ç£', icon: 'üçù' },
      { en: 'hamburger', ja: '„Éè„É≥„Éê„Éº„Ç¨„Éº', icon: 'üçî' },
      { en: 'curry and rice', ja: '„Ç´„É¨„Éº„É©„Ç§„Çπ', icon: 'üçõ' },
      { en: 'rice ball', ja: '„Åä„Å´„Åé„Çä', icon: 'üçô' },
      { en: 'salad', ja: '„Çµ„É©„ÉÄ', icon: 'ü•ó' },
      { en: 'soup', ja: '„Çπ„Éº„Éó', icon: 'üç≤' },
      { en: 'steak', ja: '„Çπ„ÉÜ„Éº„Ç≠', icon: 'ü•©' },
      { en: 'sandwich', ja: '„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ', icon: 'ü•™' },
      { en: 'fried chicken', ja: '„Éï„É©„Ç§„Éâ„ÉÅ„Ç≠„É≥', icon: 'üçó' },
      { en: 'French fries', ja: '„Éï„É©„Ç§„Éâ„Éù„ÉÜ„Éà', icon: 'üçü' },
      { en: 'ice cream', ja: '„Ç¢„Ç§„Çπ„ÇØ„É™„Éº„É†', icon: 'üç¶' },
      { en: 'cake', ja: '„Ç±„Éº„Ç≠', icon: 'üéÇ' },
      { en: 'donut', ja: '„Éâ„Éº„Éä„ÉÑ', icon: 'üç©' },
      { en: 'pudding', ja: '„Éó„É™„É≥', icon: 'üçÆ' },
      { en: 'chocolate', ja: '„ÉÅ„Éß„Ç≥„É¨„Éº„Éà', icon: 'üç´' },
      { en: 'popcorn', ja: '„Éù„ÉÉ„Éó„Ç≥„Éº„É≥', icon: 'üçø' },
      { en: 'coffee', ja: '„Ç≥„Éº„Éí„Éº', icon: '‚òï' },
      { en: 'green tea', ja: '„ÅäËå∂', icon: 'üçµ' },
      { en: 'juice', ja: '„Ç∏„É•„Éº„Çπ', icon: 'üßÉ' },
      { en: 'milk', ja: '„Éü„É´„ÇØ', icon: 'ü•õ' },
      { en: 'soda', ja: '„ÇΩ„Éº„ÉÄ', icon: 'ü•§' },
    ]
  },
  sports: {
    label: '„Çπ„Éù„Éº„ÉÑ', emoji: '‚öΩ',
    words: [
      { en: 'badminton', ja: '„Éê„Éâ„Éü„É≥„Éà„É≥', icon: 'üè∏' },
      { en: 'baseball', ja: 'ÈáéÁêÉ', icon: '‚öæ' },
      { en: 'basketball', ja: '„Éê„Çπ„Ç±„ÉÉ„Éà„Éú„Éº„É´', icon: 'üèÄ' },
      { en: 'soccer', ja: '„Çµ„ÉÉ„Ç´„Éº', icon: '‚öΩ' },
      { en: 'volleyball', ja: '„Éê„É¨„Éº„Éú„Éº„É´', icon: 'üèê' },
      { en: 'table tennis', ja: 'ÂçìÁêÉ', icon: 'üèì' },
      { en: 'tennis', ja: '„ÉÜ„Éã„Çπ', icon: 'üéæ' },
      { en: 'swimming', ja: 'Ê∞¥Ê≥≥', icon: 'üèä' },
      { en: 'gymnastics', ja: '‰ΩìÊìç', icon: 'ü§∏' },
      { en: 'dance', ja: '„ÉÄ„É≥„Çπ', icon: 'üíÉ' },
      { en: 'track and field', ja: 'Èô∏‰∏äÁ´∂ÊäÄ', icon: 'üèÉ' },
      { en: 'Japanese archery', ja: 'ÂºìÈÅì', icon: 'üèπ' },
      { en: 'ski', ja: '„Çπ„Ç≠„Éº', icon: '‚õ∑Ô∏è' },
      { en: 'skate', ja: '„Çπ„Ç±„Éº„Éà', icon: '‚õ∏Ô∏è' },
    ]
  },
  school: {
    label: 'Â≠¶Ê†°„ÉªÊïôÁßë', emoji: 'üìö',
    words: [
      { en: 'Japanese', ja: 'ÂõΩË™û', icon: 'üìñ' },
      { en: 'math', ja: 'Êï∞Â≠¶', icon: 'üìê' },
      { en: 'science', ja: 'ÁêÜÁßë', icon: 'üî¨' },
      { en: 'history', ja: 'Ê≠¥Âè≤', icon: 'üèõÔ∏è' },
      { en: 'geography', ja: 'Âú∞ÁêÜ', icon: 'üåç' },
      { en: 'civics', ja: 'ÂÖ¨Ê∞ë', icon: 'üèõÔ∏è' },
      { en: 'music', ja: 'Èü≥Ê•Ω', icon: 'üéµ' },
      { en: 'art', ja: 'ÁæéË°ì', icon: 'üé®' },
      { en: 'English', ja: 'Ëã±Ë™û', icon: 'üó£Ô∏è' },
      { en: 'P.E.', ja: '‰ΩìËÇ≤', icon: 'üèÉ' },
      { en: 'textbook', ja: 'ÊïôÁßëÊõ∏', icon: 'üìï' },
      { en: 'dictionary', ja: 'ËæûÊõ∏', icon: 'üìö' },
      { en: 'notebook', ja: '„Éé„Éº„Éà', icon: 'üìì' },
      { en: 'pencil', ja: 'ÈâõÁ≠Ü', icon: '‚úèÔ∏è' },
      { en: 'eraser', ja: 'Ê∂à„Åó„Ç¥„É†', icon: 'üßπ' },
      { en: 'scissors', ja: '„ÅØ„Åï„Åø', icon: '‚úÇÔ∏è' },
      { en: 'ruler', ja: 'ÂÆöË¶è', icon: 'üìè' },
      { en: 'pencil case', ja: 'Á≠ÜÁÆ±', icon: 'üñäÔ∏è' },
      { en: 'school bag', ja: '„Åã„Å∞„Çì', icon: 'üéí' },
      { en: 'blackboard', ja: 'ÈªíÊùø', icon: 'üñäÔ∏è' },
    ]
  },
  animals: {
    label: 'ÂãïÁâ©', emoji: 'üêò',
    words: [
      { en: 'dog', ja: 'Áä¨', icon: 'üêï' },
      { en: 'cat', ja: '„Å≠„Åì', icon: 'üêà' },
      { en: 'rabbit', ja: '„ÅÜ„Åï„Åé', icon: 'üêá' },
      { en: 'horse', ja: '„ÅÜ„Åæ', icon: 'üê¥' },
      { en: 'cow', ja: 'Áâõ', icon: 'üêÑ' },
      { en: 'pig', ja: '„Å∂„Åü', icon: 'üê∑' },
      { en: 'sheep', ja: '„Å≤„Å§„Åò', icon: 'üêë' },
      { en: 'monkey', ja: '„Åï„Çã', icon: 'üêí' },
      { en: 'tiger', ja: '„Å®„Çâ', icon: 'üêØ' },
      { en: 'bear', ja: '„Åè„Åæ', icon: 'üêª' },
      { en: 'lion', ja: '„É©„Ç§„Ç™„É≥', icon: 'ü¶Å' },
      { en: 'elephant', ja: '„Åû„ÅÜ', icon: 'üêò' },
      { en: 'panda', ja: '„Éë„É≥„ÉÄ', icon: 'üêº' },
      { en: 'koala', ja: '„Ç≥„Ç¢„É©', icon: 'üê®' },
      { en: 'gorilla', ja: '„Ç¥„É™„É©', icon: 'ü¶ç' },
      { en: 'zebra', ja: '„Ç∑„Éû„Ç¶„Éû', icon: 'ü¶ì' },
      { en: 'whale', ja: '„Åè„Åò„Çâ', icon: 'üê≥' },
      { en: 'fish', ja: 'È≠ö', icon: 'üêü' },
      { en: 'frog', ja: '„Åã„Åà„Çã', icon: 'üê∏' },
      { en: 'turtle', ja: '„Åã„ÇÅ', icon: 'üê¢' },
      { en: 'bird', ja: '„Å®„Çä', icon: 'üê¶' },
      { en: 'snake', ja: '„Å∏„Å≥', icon: 'üêç' },
      { en: 'fox', ja: '„Åç„Å§„Å≠', icon: 'ü¶ä' },
    ]
  },
  daily: {
    label: 'Êó•Â∏∏ÁîüÊ¥ª', emoji: '‚è∞',
    words: [
      { en: 'wake up', ja: 'Ëµ∑„Åç„Çã', icon: '‚è∞' },
      { en: 'get up', ja: 'Ëµ∑„Åç‰∏ä„Åå„Çã', icon: 'üõèÔ∏è' },
      { en: 'have breakfast', ja: 'ÊúùÈ£ü„ÇíÈ£ü„Åπ„Çã', icon: 'üç≥' },
      { en: 'brush my teeth', ja: 'Ê≠Ø„ÇíÁ£®„Åè', icon: 'ü¶∑' },
      { en: 'get dressed', ja: 'ÁùÄÊõø„Åà„Çã', icon: 'üëï' },
      { en: 'walk to school', ja: 'Ê≠©„ÅÑ„Å¶ÁôªÊ†°', icon: 'üö∂' },
      { en: 'have lunch', ja: 'ÊòºÈ£ü„ÇíÈ£ü„Åπ„Çã', icon: 'üç±' },
      { en: 'go home', ja: 'ÂÆ∂„Å´Â∏∞„Çã', icon: 'üè†' },
      { en: 'have dinner', ja: 'Â§ïÈ£ü„ÇíÈ£ü„Åπ„Çã', icon: 'üçΩÔ∏è' },
      { en: 'do my homework', ja: 'ÂÆøÈ°å„Çí„Åô„Çã', icon: 'üìù' },
      { en: 'watch TV', ja: '„ÉÜ„É¨„Éì„ÇíË¶ã„Çã', icon: 'üì∫' },
      { en: 'take a bath', ja: '„ÅäÈ¢®ÂëÇ„Å´ÂÖ•„Çã', icon: 'üõÅ' },
      { en: 'go to bed', ja: 'ÂØù„Çã', icon: 'üò¥' },
      { en: 'wash my face', ja: 'È°î„ÇíÊ¥ó„ÅÜ', icon: 'üíß' },
      { en: 'listen to music', ja: 'Èü≥Ê•Ω„ÇíËÅ¥„Åè', icon: 'üéß' },
      { en: 'surf the internet', ja: '„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà', icon: 'üíª' },
      { en: 'walk my dog', ja: 'Áä¨„ÅÆÊï£Ê≠©', icon: 'üêï' },
    ]
  }
};

// =====================================================
// GAME STATE
// =====================================================
let selectedCategory = null;
let selectedDiff = null;
let selectedMode = null; // 'match', 'listening', 'test'
let gameState = {
  allWords: [],
  currentSet: 0,
  totalSets: 5,
  score: 0,
  totalAttempts: 0,
  totalMatches: 0,
  cards: [],
  selectedCard: null,
  locked: false,
  setWords: [],
  // For listening/test modes
  currentQuestion: 0,
  totalQuestions: 50,
  currentWord: null,
  correctAnswers: 0
};

const DIFF_CONFIG = {
  easy:   { pairs: 4, showJa: true,  showIcon: true,  label: '‚≠ê Easy',   color: '#6bff9e' },
  medium: { pairs: 6, showJa: false, showIcon: true,  label: '‚≠ê‚≠ê Medium', color: '#ffd93d' },
  hard:   { pairs: 8, showJa: false, showIcon: false, label: '‚≠ê‚≠ê‚≠ê Hard', color: '#ff6b6b' },
};

// =====================================================
// HOME SCREEN
// =====================================================
function initHome() {
  const grid = document.getElementById('categoryGrid');
  grid.innerHTML = '';
  Object.entries(CATEGORIES).forEach(([key, cat]) => {
    const btn = document.createElement('button');
    btn.className = 'cat-btn' + (selectedCategory === key ? ' selected' : '');
    btn.innerHTML = `
      <span class="cat-emoji">${cat.emoji}</span>
      <strong>${cat.label}</strong>
      <div class="cat-count">${cat.words.length}Ë™û</div>
    `;
    btn.onclick = () => selectCategory(key);
    grid.appendChild(btn);
  });

  // Re-render mode buttons
  const modeBtns = document.querySelectorAll('.difficulty-row')[0].querySelectorAll('.diff-btn');
  modeBtns[0].classList.toggle('selected', selectedMode === 'match');
  modeBtns[1].classList.toggle('selected', selectedMode === 'listening');
  modeBtns[2].classList.toggle('selected', selectedMode === 'test');

  // Re-render difficulty buttons
  const diffBtns = document.querySelectorAll('.difficulty-row')[1].querySelectorAll('.diff-btn');
  diffBtns[0].classList.toggle('selected', selectedDiff === 'easy');
  diffBtns[1].classList.toggle('selected', selectedDiff === 'medium');
  diffBtns[2].classList.toggle('selected', selectedDiff === 'hard');

  updateStartBtn();
}

function selectCategory(key) {
  selectedCategory = key;
  initHome();
}

function selectMode(mode) {
  selectedMode = mode;
  initHome();
}

function selectDiff(diff) {
  selectedDiff = diff;
  initHome();
}

function updateStartBtn() {
  document.getElementById('startBtn').disabled = !(selectedCategory && selectedDiff && selectedMode);
}

// =====================================================
// GAME SETUP
// =====================================================
function startGame() {
  if (!selectedCategory || !selectedDiff || !selectedMode) return;

  const words = [...CATEGORIES[selectedCategory].words];
  shuffle(words);

  gameState = {
    allWords: words,
    currentSet: 0,
    totalSets: 5,
    score: 0,
    totalAttempts: 0,
    totalMatches: 0,
    cards: [],
    selectedCard: null,
    locked: false,
    setWords: [],
    currentQuestion: 0,
    totalQuestions: 50,
    currentWord: null,
    correctAnswers: 0
  };

  if (selectedMode === 'match') {
    showScreen('game');
    loadSet();
  } else if (selectedMode === 'listening') {
    showScreen('listening');
    startListeningMode();
  } else if (selectedMode === 'test') {
    showScreen('test');
    startTestMode();
  }
}

function loadSet() {
  const config = DIFF_CONFIG[selectedDiff];
  const setIdx = gameState.currentSet;
  const wordsPerSet = config.pairs;

  // Pick 'wordsPerSet' words for this set
  const startIdx = (setIdx * wordsPerSet) % gameState.allWords.length;
  let pool = [];
  for (let i = 0; i < wordsPerSet; i++) {
    pool.push(gameState.allWords[(startIdx + i) % gameState.allWords.length]);
  }

  gameState.setWords = pool;

  // Update header
  document.getElementById('scoreDisplay').textContent = gameState.score;
  document.getElementById('setDisplay').textContent = `${setIdx + 1}/${gameState.totalSets}`;
  const pill = document.getElementById('diffPill');
  pill.textContent = config.label;
  pill.style.color = config.color;

  updateProgress(0);
  renderCards(pool, config);
}

function renderCards(words, config) {
  const container = document.getElementById('cardsContainer');
  container.innerHTML = '';

  // Build EN cards + JP cards
  const enCards = words.map((w, i) => ({
    id: i, type: 'en', word: w,
    display: w.en, sub: config.showIcon ? w.icon : '',
    key: w.en
  }));

  const jpCards = words.map((w, i) => ({
    id: i, type: 'jp', word: w,
    display: config.showJa ? w.ja : (config.showIcon ? w.icon : '?'),
    sub: config.showJa ? (config.showIcon ? w.icon : '') : (config.showJa ? w.ja : ''),
    key: w.en
  }));

  shuffle(enCards);
  shuffle(jpCards);
  gameState.cards = [];

  // Top row: English
  const topLabel = document.createElement('div');
  topLabel.className = 'section-label';
  topLabel.textContent = 'üá¨üáß Ëã±Ë™û';
  container.appendChild(topLabel);

  const topRow = document.createElement('div');
  topRow.className = 'cards-row';
  enCards.forEach(c => {
    const el = buildCard(c, config);
    topRow.appendChild(el);
    gameState.cards.push({ ...c, el });
  });
  container.appendChild(topRow);

  // Bottom row: Japanese/Icon
  const botLabel = document.createElement('div');
  botLabel.className = 'section-label';
  botLabel.textContent = config.showJa ? 'üáØüáµ Êó•Êú¨Ë™û' : (config.showIcon ? 'üñºÔ∏è „Ç§„É©„Çπ„Éà' : '‚ùì „Éí„É≥„Éà');
  container.appendChild(botLabel);

  const botRow = document.createElement('div');
  botRow.className = 'cards-row';
  jpCards.forEach(c => {
    const el = buildCard(c, config);
    botRow.appendChild(el);
    gameState.cards.push({ ...c, el });
  });
  container.appendChild(botRow);
}

function buildCard(cardData, config) {
  const el = document.createElement('div');
  el.className = 'card';

  // Speak button only on EN cards
  if (cardData.type === 'en') {
    const speakBtn = document.createElement('button');
    speakBtn.className = 'speak-btn';
    speakBtn.textContent = 'üîä';
    speakBtn.title = 'Pronounce';
    speakBtn.onclick = (e) => { e.stopPropagation(); speak(cardData.word.en); };
    el.appendChild(speakBtn);
  }

  if (cardData.type === 'en') {
    if (config.showIcon) {
      const icon = document.createElement('div');
      icon.className = 'emoji-icon';
      icon.textContent = cardData.word.icon;
      el.appendChild(icon);
    }
    const word = document.createElement('div');
    word.className = 'word-en';
    word.textContent = cardData.display;
    el.appendChild(word);
  } else {
    // JP card
    if (!config.showJa && config.showIcon) {
      const icon = document.createElement('div');
      icon.className = 'emoji-icon';
      icon.style.fontSize = '2rem';
      icon.textContent = cardData.word.icon;
      el.appendChild(icon);
    }
    if (config.showJa) {
      const ja = document.createElement('div');
      ja.style.fontSize = '1.1rem';
      ja.style.fontWeight = '900';
      ja.textContent = cardData.word.ja;
      el.appendChild(ja);
      if (config.showIcon) {
        const icon = document.createElement('div');
        icon.className = 'emoji-icon';
        icon.style.fontSize = '1.2rem';
        icon.textContent = cardData.word.icon;
        el.appendChild(icon);
      }
    }
    if (!config.showJa && !config.showIcon) {
      // Hard: show only first letter
      const hint = document.createElement('div');
      hint.style.fontSize = '1.8rem';
      hint.style.fontWeight = '900';
      hint.style.color = 'var(--muted)';
      hint.textContent = cardData.word.ja;
      el.appendChild(hint);
    }
  }

  el.onclick = () => onCardClick(cardData.key + ':' + cardData.type, el, cardData);
  cardData.el = el;
  return el;
}

// =====================================================
// GAME LOGIC
// =====================================================
function onCardClick(uid, el, cardData) {
  if (gameState.locked) return;
  if (el.classList.contains('matched')) return;
  if (el.classList.contains('selected')) {
    el.classList.remove('selected');
    gameState.selectedCard = null;
    return;
  }

  el.classList.add('selected');
  speak(cardData.word.en);

  if (!gameState.selectedCard) {
    gameState.selectedCard = { el, cardData };
  } else {
    const prev = gameState.selectedCard;
    gameState.selectedCard = null;

    // Same type ‚Äî swap selection
    if (prev.cardData.type === cardData.type) {
      prev.el.classList.remove('selected');
      gameState.selectedCard = { el, cardData };
      return;
    }

    gameState.totalAttempts++;

    if (prev.cardData.key === cardData.key) {
      // MATCH!
      gameState.locked = true;
      setTimeout(() => {
        prev.el.classList.remove('selected');
        cardData.el && el.classList.remove('selected');
        prev.el.classList.add('matched');
        el.classList.add('matched');
        gameState.totalMatches++;

        const setWords = gameState.setWords;
        const matchedCount = document.querySelectorAll('.card.matched').length / 2;
        const progress = matchedCount / setWords.length;
        updateProgress(progress);

        // Score
        const bonus = selectedDiff === 'easy' ? 10 : selectedDiff === 'medium' ? 20 : 30;
        gameState.score += bonus;
        document.getElementById('scoreDisplay').textContent = gameState.score;
        showToast(`+${bonus} ‚ú® Ê≠£Ëß£ÔºÅ`);

        gameState.locked = false;

        if (matchedCount >= setWords.length) {
          setTimeout(onSetComplete, 600);
        }
      }, 300);
    } else {
      // WRONG
      gameState.locked = true;
      prev.el.classList.add('wrong');
      el.classList.add('wrong');

      setTimeout(() => {
        prev.el.classList.remove('selected', 'wrong');
        el.classList.remove('selected', 'wrong');
        gameState.locked = false;
      }, 700);
    }
  }
}

function onSetComplete() {
  gameState.currentSet++;
  if (gameState.currentSet >= gameState.totalSets) {
    showResult();
  } else {
    showToast(`üéâ „Çª„ÉÉ„Éà${gameState.currentSet}„ÇØ„É™„Ç¢ÔºÅ`);
    setTimeout(loadSet, 800);
  }
}

// =====================================================
// LISTENING MODE
// =====================================================
function startListeningMode() {
  gameState.currentQuestion = 0;
  gameState.score = 0;
  gameState.correctAnswers = 0;
  gameState.totalAttempts = 0;
  nextListeningQuestion();
}

function nextListeningQuestion() {
  if (gameState.currentQuestion >= gameState.totalQuestions) {
    showListeningResult();
    return;
  }

  gameState.currentQuestion++;
  const qNum = gameState.currentQuestion;
  document.getElementById('listeningQuestion').textContent = `${qNum}/${gameState.totalQuestions}`;
  document.getElementById('listeningScore').textContent = gameState.score;
  document.getElementById('listeningProgress').style.width = ((qNum / gameState.totalQuestions) * 100) + '%';

  // Pick random word
  const correctWord = gameState.allWords[Math.floor(Math.random() * gameState.allWords.length)];
  gameState.currentWord = correctWord;

  // Generate 3 wrong options
  const wrongWords = [];
  while (wrongWords.length < 3) {
    const w = gameState.allWords[Math.floor(Math.random() * gameState.allWords.length)];
    if (w.en !== correctWord.en && !wrongWords.find(x => x.en === w.en)) {
      wrongWords.push(w);
    }
  }

  const options = shuffle([correctWord, ...wrongWords]);

  // Render options
  const container = document.getElementById('listeningOptions');
  container.innerHTML = '';
  options.forEach(word => {
    const btn = document.createElement('div');
    btn.className = 'listening-option';
    btn.innerHTML = `
      <div class="option-icon">${word.icon}</div>
      <div>${word.ja}</div>
    `;
    btn.onclick = () => checkListeningAnswer(word.en === correctWord.en, btn);
    container.appendChild(btn);
  });
}

function playListeningWord() {
  if (gameState.currentWord) {
    speak(gameState.currentWord.en);
  }
}

function checkListeningAnswer(isCorrect, btn) {
  if (gameState.locked) return;
  gameState.locked = true;
  gameState.totalAttempts++;

  if (isCorrect) {
    btn.classList.add('correct');
    const bonus = selectedDiff === 'easy' ? 10 : selectedDiff === 'medium' ? 20 : 30;
    gameState.score += bonus;
    gameState.correctAnswers++;
    showToast(`+${bonus} ‚ú® Ê≠£Ëß£ÔºÅ`);
    setTimeout(() => {
      gameState.locked = false;
      nextListeningQuestion();
    }, 1000);
  } else {
    btn.classList.add('incorrect');
    showToast('‚ùå ‰∏çÊ≠£Ëß£');
    setTimeout(() => {
      btn.classList.remove('incorrect');
      gameState.locked = false;
    }, 800);
  }
}

function showListeningResult() {
  const accuracy = gameState.totalAttempts > 0
    ? Math.round((gameState.correctAnswers / gameState.totalAttempts) * 100) : 0;

  document.getElementById('finalScore').textContent = gameState.score;
  document.getElementById('finalAccuracy').textContent = accuracy + '%';
  document.getElementById('finalMatches').textContent = gameState.correctAnswers + '/' + gameState.totalQuestions;

  let emoji = 'üåü', title = '„Åô„Åî„ÅÑÔºÅ';
  if (accuracy === 100) { emoji = 'üèÜ'; title = '„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ'; }
  else if (accuracy >= 80) { emoji = 'üéâ'; title = '„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ'; }
  else if (accuracy >= 60) { emoji = 'üòä'; title = '„Åå„Çì„Å∞„Çä„Åæ„Åó„ÅüÔºÅ'; }
  else { emoji = 'üí™'; title = '„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶ÔºÅ'; }

  document.getElementById('resultEmoji').textContent = emoji;
  document.getElementById('resultTitle').textContent = title;

  showScreen('result');
  if (accuracy >= 80) launchConfetti();
}

// =====================================================
// TEST MODE
// =====================================================
function startTestMode() {
  gameState.currentQuestion = 0;
  gameState.score = 0;
  gameState.correctAnswers = 0;
  gameState.totalAttempts = 0;
  nextTestQuestion();
}

function nextTestQuestion() {
  if (gameState.currentQuestion >= gameState.totalQuestions) {
    showTestResult();
    return;
  }

  gameState.currentQuestion++;
  const qNum = gameState.currentQuestion;
  document.getElementById('testQuestion').textContent = `${qNum}/${gameState.totalQuestions}`;
  document.getElementById('testScore').textContent = gameState.score;
  document.getElementById('testProgress').style.width = ((qNum / gameState.totalQuestions) * 100) + '%';

  // Pick random word
  const word = gameState.allWords[Math.floor(Math.random() * gameState.allWords.length)];
  gameState.currentWord = word;

  document.getElementById('testIcon').textContent = word.icon;
  document.getElementById('testWord').textContent = word.ja;
  
  const input = document.getElementById('testInput');
  input.value = '';
  input.className = '';
  input.disabled = false;
  input.focus();
}

function checkTestAnswer() {
  const input = document.getElementById('testInput');
  const userAnswer = input.value.trim().toLowerCase();
  const correctAnswer = gameState.currentWord.en.toLowerCase();

  if (!userAnswer) {
    showToast('‚ö†Ô∏è ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  if (gameState.locked) return;
  gameState.locked = true;
  gameState.totalAttempts++;

  if (userAnswer === correctAnswer) {
    input.classList.add('correct');
    const bonus = selectedDiff === 'easy' ? 10 : selectedDiff === 'medium' ? 20 : 30;
    gameState.score += bonus;
    gameState.correctAnswers++;
    showToast(`+${bonus} ‚ú® Ê≠£Ëß£ÔºÅ`);
    speak(correctAnswer);
    setTimeout(() => {
      gameState.locked = false;
      nextTestQuestion();
    }, 1500);
  } else {
    input.classList.add('incorrect');
    input.disabled = true;
    showToast(`‚ùå Ê≠£Ëß£: ${gameState.currentWord.en}`);
    speak(correctAnswer);
    setTimeout(() => {
      gameState.locked = false;
      nextTestQuestion();
    }, 2500);
  }
}

function showTestResult() {
  const accuracy = gameState.totalAttempts > 0
    ? Math.round((gameState.correctAnswers / gameState.totalAttempts) * 100) : 0;

  document.getElementById('finalScore').textContent = gameState.score;
  document.getElementById('finalAccuracy').textContent = accuracy + '%';
  document.getElementById('finalMatches').textContent = gameState.correctAnswers + '/' + gameState.totalQuestions;

  let emoji = 'üåü', title = '„Åô„Åî„ÅÑÔºÅ';
  if (accuracy === 100) { emoji = 'üèÜ'; title = '„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ'; }
  else if (accuracy >= 80) { emoji = 'üéâ'; title = '„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ'; }
  else if (accuracy >= 60) { emoji = 'üòä'; title = '„Åå„Çì„Å∞„Çä„Åæ„Åó„ÅüÔºÅ'; }
  else { emoji = 'üí™'; title = '„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶ÔºÅ'; }

  document.getElementById('resultEmoji').textContent = emoji;
  document.getElementById('resultTitle').textContent = title;

  showScreen('result');
  if (accuracy >= 80) launchConfetti();
}

// =====================================================
// RESULT
// =====================================================
function showResult() {
  const accuracy = gameState.totalAttempts > 0
    ? Math.round((gameState.totalMatches / gameState.totalAttempts) * 100) : 100;

  document.getElementById('finalScore').textContent = gameState.score;
  document.getElementById('finalAccuracy').textContent = accuracy + '%';
  document.getElementById('finalMatches').textContent = gameState.totalMatches;

  let emoji = 'üåü', title = '„Åô„Åî„ÅÑÔºÅ';
  if (accuracy === 100) { emoji = 'üèÜ'; title = '„Éë„Éº„Éï„Çß„ÇØ„ÉàÔºÅ'; }
  else if (accuracy >= 80) { emoji = 'üéâ'; title = '„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ'; }
  else if (accuracy >= 60) { emoji = 'üòä'; title = '„Åå„Çì„Å∞„Çä„Åæ„Åó„ÅüÔºÅ'; }
  else { emoji = 'üí™'; title = '„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶ÔºÅ'; }

  document.getElementById('resultEmoji').textContent = emoji;
  document.getElementById('resultTitle').textContent = title;

  showScreen('result');
  if (accuracy >= 80) launchConfetti();
}

function retryGame() { startGame(); }
function goHome() { showScreen('home'); initHome(); }

// =====================================================
// UTILS
// =====================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function updateProgress(ratio) {
  document.getElementById('progressFill').style.width = (ratio * 100) + '%';
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function speak(text) {
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  u.rate = 0.85;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 1500);
}

function launchConfetti() {
  const colors = ['#ff6b6b','#ffd93d','#6bceff','#6bff9e','#ff9f43','#a29bfe'];
  for (let i = 0; i < 50; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = Math.random() * 100 + 'vw';
    el.style.background = colors[Math.floor(Math.random() * colors.length)];
    el.style.animationDuration = (1.5 + Math.random() * 2) + 's';
    el.style.animationDelay = (Math.random() * 1) + 's';
    el.style.transform = `rotate(${Math.random() * 360}deg)`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
}

// =====================================================
// INIT
// =====================================================
initHome();
</script>
</body>
</html>

